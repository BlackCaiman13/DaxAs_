<ion-header collapse="fade">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/request"></ion-back-button>
    </ion-buttons>
    <ion-title style="text-align: center; font-weight: bold; font-size: 1.3rem;">Détails de la réparation</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="details-content">
  @if (loading) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Chargement des détails...</p>
    </div>
  } @else if (request) {
    <div class="details-container">
      <div class="header-section">
        <div class="request-id">Demande #{{request.id}}</div>
        <ion-badge [color]="getStatusColor(request.status)">
          {{getStatusLabel(request.status)}}
        </ion-badge>
      </div>

      <ion-card class="info-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="phone-portrait-outline"></ion-icon>
            Informations de l'appareil
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="info-row">
            <span class="label">Modèle:</span>
            <span class="value">{{request.model}}</span>
          </div>
          <div class="info-row">
            <span class="label">Description du problème:</span>
            <span class="value">{{request.problem_description}}</span>
          </div>
          @if (request.scheduled_at) {
            <div class="info-row">
              <span class="label">Date de collecte:</span>
              <span class="value">
                <ion-icon name="calendar-outline"></ion-icon>
                {{formatDate(request.scheduled_at)}}
              </span>
            </div>
          }
          @if (request.location) {
            <div class="info-row">
              <span class="label">Localisation:</span>
              <span class="value">
                <ion-icon name="location-outline"></ion-icon>
                {{request.location}}
                @if (request.location_details) {
                  <br><small>{{request.location_details}}</small>
                }
              </span>
            </div>
          }
        </ion-card-content>
      </ion-card>

      @if (request.photos && request.photos.length > 0) {
        <ion-card class="photos-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="images-outline"></ion-icon>
              Photos téléchargées
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="photos-grid">
              @for (photo of request.photos; track photo.id; let i = $index) {
                <div class="photo-item" (click)="openPhotoModal(i)">
                  <img [src]="getPhotoUrl(photo)" alt="Photo de la demande" />
                  <div class="photo-overlay">
                    <ion-icon name="expand-outline"></ion-icon>
                  </div>
                </div>
              }
            </div>
          </ion-card-content>
        </ion-card>
      }

      @if (quote) {
        <ion-card class="quote-card">
          <ion-card-header>
            <div class="quote-header">
              <ion-card-title>
                <ion-icon name="document-text-outline"></ion-icon>
                Devis proposé
              </ion-card-title>
              <ion-badge [color]="getQuoteStatusColor(quote.status)">
                {{getQuoteStatusLabel(quote.status)}}
              </ion-badge>
            </div>
          </ion-card-header>
          <ion-card-content>
            <div class="quote-amount">
              <span class="label">Montant:</span>
              <span class="amount">{{formatAmount(quote.amount)}}</span>
            </div>
            <div class="quote-row">
              <span class="label">Durée estimée:</span>
              <span class="value">{{quote.estimated_duration}}</span>
            </div>
            <div class="quote-row">
              <span class="label">Description des travaux:</span>
              <p class="description">{{quote.description_travaux}}</p>
            </div>
            @if (quote.parts_needed) {
              <div class="quote-row">
                <span class="label">Pièces nécessaires:</span>
                <p class="description">{{quote.parts_needed}}</p>
              </div>
            }
            <div class="quote-row">
              <span class="label">Date de création:</span>
              <span class="value">{{formatDate(quote.created_at)}}</span>
            </div>

            @if (quote.status === 'pending') {
              <div class="quote-actions">
                <ion-button expand="block" color="success" (click)="acceptQuote()">
                  <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                  Accepter le devis
                </ion-button>
                <ion-button expand="block" color="danger" fill="outline" (click)="rejectQuote()">
                  <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                  Refuser le devis
                </ion-button>
              </div>
            }

            @if (quote.status === 'rejected' && quote.rejection_reason) {
              <div class="rejection-reason">
                <ion-icon name="information-circle-outline"></ion-icon>
                <span>Raison du refus: {{quote.rejection_reason}}</span>
              </div>
            }
          </ion-card-content>
        </ion-card>
      } @else {
        <ion-card class="no-quote-card">
          <ion-card-content>
            <div class="no-quote-message">
              <ion-icon name="time-outline" size="large"></ion-icon>
              <h3>En attente du devis</h3>
              <p>Le réparateur prépare votre devis. Vous serez notifié dès qu'il sera disponible.</p>
            </div>
          </ion-card-content>
        </ion-card>
      }

      @if (request.assignment && request.assignment.length > 0 && request.assignment[0].repairer) {
        <ion-card class="repairer-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="person-outline"></ion-icon>
              Réparateur assigné
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="repairer-details">
              <div class="repairer-avatar">
                @if (request.assignment[0].repairer.avatar_url) {
                  <img [src]="request.assignment[0].repairer.avatar_url" alt="Avatar" />
                } @else {
                  <ion-icon name="person-circle-outline"></ion-icon>
                }
              </div>
              <div class="repairer-info-detailed">
                <h4>{{request.assignment[0].repairer.fullname}}</h4>
                @if (request.assignment[0].repairer.phone) {
                  <a [href]="'tel:' + request.assignment[0].repairer.phone" class="contact-link">
                    <ion-icon name="call-outline"></ion-icon>
                    {{request.assignment[0].repairer.phone}}
                  </a>
                }
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      }

      <ion-card class="timeline-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="git-commit-outline"></ion-icon>
            Suivi de la réparation
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="timeline">
            <div class="timeline-item" [class.active]="true">
              <div class="timeline-marker completed">
                <ion-icon name="checkmark-circle"></ion-icon>
              </div>
              <div class="timeline-content">
                <h4>Demande créée</h4>
                <p class="timeline-date">{{formatDate(request.created_at)}}</p>
              </div>
            </div>

            @if (request.assignment && request.assignment.length > 0) {
              <div class="timeline-item" [class.active]="true">
                <div class="timeline-marker completed">
                  <ion-icon name="person-add"></ion-icon>
                </div>
                <div class="timeline-content">
                  <h4>Assigné à un réparateur</h4>
                  <p class="timeline-date">{{formatDate(request.assignment[0].assigned_at)}}</p>
                  <p class="timeline-detail">{{request.assignment[0].repairer.fullname}}</p>
                </div>
              </div>
            }

            @if (quote) {
              <div class="timeline-item" [class.active]="true">
                <div class="timeline-marker" [class.completed]="quote.status !== 'pending'">
                  <ion-icon name="document-text"></ion-icon>
                </div>
                <div class="timeline-content">
                  <h4>Devis proposé</h4>
                  <p class="timeline-date">{{formatDate(quote.created_at)}}</p>
                  <p class="timeline-detail">Montant: {{formatAmount(quote.amount)}}</p>
                </div>
              </div>
            }

            @if (quote && quote.status === 'accepted') {
              <div class="timeline-item" [class.active]="true">
                <div class="timeline-marker completed">
                  <ion-icon name="checkmark-circle"></ion-icon>
                </div>
                <div class="timeline-content">
                  <h4>Devis accepté</h4>
                  <p class="timeline-date">{{formatDate(quote.updated_at)}}</p>
                </div>
              </div>
            }

            @if (payment) {
              <div class="timeline-item" [class.active]="true">
                <div class="timeline-marker" [class.completed]="payment.status === 'completed'">
                  <ion-icon name="cash"></ion-icon>
                </div>
                <div class="timeline-content">
                  <h4>Paiement confirmé</h4>
                  <p class="timeline-date">{{formatDate(payment.created_at)}}</p>
                  <p class="timeline-detail">Mode: Espèces</p>
                </div>
              </div>
            }

            @if (request.status === 'in_progress') {
              <div class="timeline-item" [class.active]="true">
                <div class="timeline-marker current">
                  <ion-icon name="construct"></ion-icon>
                </div>
                <div class="timeline-content">
                  <h4>Réparation en cours</h4>
                  <p class="timeline-detail">Votre appareil est en cours de réparation</p>
                </div>
              </div>
            }

            @if (request.status === 'completed') {
              <div class="timeline-item" [class.active]="true">
                <div class="timeline-marker completed">
                  <ion-icon name="checkmark-done"></ion-icon>
                </div>
                <div class="timeline-content">
                  <h4>Réparation terminée</h4>
                  <p class="timeline-detail">Votre appareil est prêt pour la collecte</p>
                </div>
              </div>
            }

            @if (payment && payment.status === 'completed') {
              <div class="timeline-item" [class.active]="true">
                <div class="timeline-marker completed">
                  <ion-icon name="checkmark-done-circle"></ion-icon>
                </div>
                <div class="timeline-content">
                  <h4>Paiement collecté</h4>
                  @if (payment.payment_date) {
                    <p class="timeline-date">{{formatDate(payment.payment_date)}}</p>
                  }
                </div>
              </div>
            }
          </div>
        </ion-card-content>
      </ion-card>

      @if (quote && quote.status === 'accepted') {
        <ion-card class="payment-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="cash-outline"></ion-icon>
              Paiement en espèces
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            @if (payment) {
              <div class="payment-confirmed">
                <ion-icon name="checkmark-circle" color="success" size="large"></ion-icon>
                <h3>Paiement confirmé</h3>
                <p class="payment-amount">{{formatAmount(payment.amount)}}</p>
                <p class="payment-info">
                  Vous paierez ce montant en espèces lors de la récupération de votre appareil réparé.
                </p>
                @if (payment.status === 'completed') {
                  <div class="payment-completed">
                    <ion-badge color="success">Paiement collecté</ion-badge>
                    @if (payment.payment_date) {
                      <p>Le {{formatDate(payment.payment_date)}}</p>
                    }
                  </div>
                } @else {
                  <ion-badge color="warning">En attente de collecte</ion-badge>
                }
              </div>
            } @else {
              <div class="payment-pending">
                <p class="payment-message">
                  Vous paierez <strong>{{formatAmount(quote.amount)}}</strong> en espèces lors de la récupération de votre appareil.
                </p>
                <ion-button expand="block" color="primary" (click)="confirmCashPayment()">
                  <ion-icon slot="start" name="cash-outline"></ion-icon>
                  Confirmer le paiement en espèces
                </ion-button>
              </div>
            }
          </ion-card-content>
        </ion-card>
      }
    </div>
  } @else {
    <div class="error-state">
      <ion-icon name="alert-circle-outline" size="large"></ion-icon>
      <h2>Demande introuvable</h2>
      <p>Cette demande n'existe pas ou vous n'y avez pas accès.</p>
      <ion-button [routerLink]="['/tabs/request']" color="primary">
        Retour aux demandes
      </ion-button>
    </div>
  }
</ion-content>
